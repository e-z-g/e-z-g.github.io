<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Cubemap Viewer Demo (Fixed)</title>
  <style>
    @import url('https://cdn.jsdelivr.net/npm/@photo-sphere-viewer/core@5/index.css');
    html, body, #viewer {
      width: 100%;
      height: 100%;
      margin: 0;
      font-family: sans-serif;
    }
  </style>

  <script type="importmap">
    {
      "imports": {
        "three": "https://cdn.jsdelivr.net/npm/three/build/three.module.js",
        "@photo-sphere-viewer/core": "https://cdn.jsdelivr.net/npm/@photo-sphere-viewer/core@5/index.module.js",
        "@photo-sphere-viewer/autorotate-plugin": "https://cdn.jsdelivr.net/npm/@photo-sphere-viewer/autorotate-plugin@5/index.module.js",
        "@photo-sphere-viewer/cubemap-adapter": "https://cdn.jsdelivr.net/npm/@photo-sphere-viewer/cubemap-adapter@5/index.module.js"
      }
    }
  </script>
</head>
<body>
  <div id="viewer"></div>

  <script type="module">
    import { Viewer, utils } from '@photo-sphere-viewer/core';
    import { AutorotatePlugin } from '@photo-sphere-viewer/autorotate-plugin';
    import { CubemapAdapter } from '@photo-sphere-viewer/cubemap-adapter';

    const baseUrl = 'https://raw.githubusercontent.com/e-z-g/e-z-g.github.io/main/cubemapvr/';
    const suffix = '-orig.jpg';

    const animatedValues = {
      pitch: { start: -Math.PI / 2, end: 0 },
      yaw: { start: Math.PI / 2, end: 0 },
      zoom: { start: 0, end: 50 },
      maxFov: { start: 130, end: 90 },
      fisheye: { start: 2, end: 0 },
    };

    const viewer = new Viewer({
      container: 'viewer',
      adapter: CubemapAdapter,
      panorama: {
        left:   baseUrl + 'LEIS665' + suffix,
        front:  baseUrl + 'LEIS661' + suffix,
        right:  baseUrl + 'LEIS664' + suffix,
        back:   baseUrl + 'LEIS663' + suffix,
        top:    baseUrl + 'LEIS666' + suffix,
        bottom: baseUrl + 'LEIS662' + suffix,
      },
      defaultPitch: animatedValues.pitch.start,
      defaultYaw: animatedValues.yaw.start,
      defaultZoomLvl: animatedValues.zoom.start,
      maxFov: animatedValues.maxFov.start,
      fisheye: animatedValues.fisheye.start,
      caption: 'This product was created using artwork by Cyan. Not official or endorsed by Cyan.',
      loadingImg: 'https://photo-sphere-viewer-data.netlify.app/assets/loader.gif',
      touchmoveTwoFingers: false,
      mousewheelCtrlKey: true,
      navbar: ['autorotate', 'zoom', 'caption', 'fullscreen'],
      plugins: [
        [AutorotatePlugin, { autostartDelay: null, autostartOnIdle: false, autorotatePitch: 0 }],
      ],
    });

    /**
     * Performs the intro animation after panorama fully loads.
     */
    async function runIntroAnimation() {
      await new Promise(resolve => setTimeout(resolve, 1500));

      // Animate zoom, pitch, yaw
      await viewer.animate({
        zoom: animatedValues.zoom.end,
        pitch: animatedValues.pitch.end,
        yaw: animatedValues.yaw.end,
        speed: '2000ms',
      });

      // Smoothly adjust FoV and fisheye AFTER the main animation
      new utils.Animation({
        properties: {
          maxFov: { from: animatedValues.maxFov.start, to: animatedValues.maxFov.end },
          fisheye: { from: animatedValues.fisheye.start, to: animatedValues.fisheye.end },
        },
        duration: 2000,
        easing: 'inOutCubic',
        onTick: (props) => viewer.setOptions(props),
      });

      // Start autorotation safely using plugin API
      const auto = viewer.getPlugin(AutorotatePlugin);
      auto.setOptions({ autorotateSpeed: '0.05rpm', autorotatePitch: 0 });
      auto.start();
    }

    // Wait until all cube faces are fully loaded before animation
    viewer.addEventListener('panorama-loaded', runIntroAnimation, { once: true });

    // Log any rendering issues
    viewer.addEventListener('error', e => console.error('PSV Error:', e));
  </script>
</body>
</html>
