<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Cubemap Viewer Demo</title>
  <style>
    @import url('https://cdn.jsdelivr.net/npm/@photo-sphere-viewer/core@5/index.css');
    html, body, #viewer {
      width: 100%;
      height: 100%;
      margin: 0;
      font-family: sans-serif;
    }
  </style>
  <script type="importmap">
    {
      "imports": {
        "three": "https://cdn.jsdelivr.net/npm/three/build/three.module.js",
        "@photo-sphere-viewer/core": "https://cdn.jsdelivr.net/npm/@photo-sphere-viewer/core@5/index.module.js",
        "@photo-sphere-viewer/autorotate-plugin": "https://cdn.jsdelivr.net/npm/@photo-sphere-viewer/autorotate-plugin@5/index.module.js",
        "@photo-sphere-viewer/cubemap-adapter": "https://cdn.jsdelivr.net/npm/@photo-sphere-viewer/cubemap-adapter@5/index.module.js"
      }
    }
  </script>
</head>
<body>
  <div id="viewer"></div>
  <script type="module">
    import { Viewer, utils } from '@photo-sphere-viewer/core';
    import { AutorotatePlugin } from '@photo-sphere-viewer/autorotate-plugin';
    import { CubemapAdapter } from '@photo-sphere-viewer/cubemap-adapter';

    const baseUrl = 'https://raw.githubusercontent.com/e-z-g/e-z-g.github.io/main/cubemapvr/';
    const suffixUrl = '-6144.webp';

    const animatedValues = {
        pitch: { start: -Math.PI / 2, end: 0 },
        yaw: { start: Math.PI / 2, end: 0 },
        zoom: { start: 0, end: 50 },
        maxFov: { start: 130, end: 90 },
        fisheye: { start: 2, end: 0 },
    };

    const viewer = new Viewer({
      container: 'viewer',
      adapter: CubemapAdapter,
      // Set initial values directly
      defaultPitch: animatedValues.pitch.start,
      defaultYaw: animatedValues.yaw.start,
      defaultZoomLvl: animatedValues.zoom.start,
      maxFov: animatedValues.maxFov.start,
      fisheye: animatedValues.fisheye.start,
      panorama: {
        left:   baseUrl + 'LEIS665' + suffixUrl,
        front:  baseUrl + 'LEIS661' + suffixUrl,
        right:  baseUrl + 'LEIS664' + suffixUrl,
        back:   baseUrl + 'LEIS663' + suffixUrl,
        top:    baseUrl + 'LEIS666' + suffixUrl,
        bottom: baseUrl + 'LEIS662' + suffixUrl,
      },
      caption: 'This product was created using artwork with â„¢ and/or Â© works of Cyan. All rights reserved by Cyan. This product is not official and is not endorsed by Cyan.',
      loadingImg: 'https://photo-sphere-viewer-data.netlify.app/assets/loader.gif',
      touchmoveTwoFingers: false,
      mousewheelCtrlKey: false,
      navbar: [
        'autorotate', 'zoom',
        {
            title: 'Rerun animation',
            content: 'ðŸ”„',
            onClick: reset,
        },
        'caption', 'fullscreen',
      ],
      plugins: [
        [AutorotatePlugin, {
            autostartDelay: null,
            autostartOnIdle: false,
            autorotatePitch: 0,
        }],
      ],
    });

    /**
     * Runs the intro animation.
     */
    function runIntroAnimation() {
      // Temporarily disable user controls
      viewer.setOptions({ mousemove: false, mousewheel: false });

      // Animate fisheye and maxFov separately for better performance
      new utils.Animation({
        properties: {
          fisheye: { from: animatedValues.fisheye.start, to: animatedValues.fisheye.end },
          maxFov:  { from: animatedValues.maxFov.start,  to: animatedValues.maxFov.end },
        },
        duration: 2000,
        easing: 'inOutCubic',
        onTick: (properties) => {
          viewer.setOptions({
            fisheye: properties.fisheye,
            maxFov: properties.maxFov,
          });
        },
      });

      // Use the built-in, optimized animate method for camera position and zoom
      viewer.animate({
        pitch: animatedValues.pitch.end,
        yaw: animatedValues.yaw.end,
        zoom: animatedValues.zoom.end,
        speed: '2000ms', // Use the 'speed' property for duration
      }).then(() => {
        // Re-enable user controls after the animation is complete
        viewer.setOptions({ mousemove: true, mousewheel: true });
      });
    }

    /**
     * Resets the view and reruns the intro animation.
     */
    function reset() {
      // Stop any ongoing animation before starting a new one
      viewer.stopAnimation().then(() => {
          runIntroAnimation();
      });
    }

    // Run the animation once the viewer is ready
    viewer.addEventListener('ready', runIntroAnimation, { once: true });

  </script>
</body>
</html>
